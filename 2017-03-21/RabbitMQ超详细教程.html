<!-- build time:Sun Aug 11 2019 10:32:49 GMT+0800 (GMT+08:00) --><!DOCTYPE html><html class="theme-next mist use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta name="baidu-site-verification" content="nVSPnsG6Cm"><script></script><script src="/lib/pace/pace.min.js?v=1.0.2"></script><link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>!function(e,t,o,c,i,a,n){e.DaoVoiceObject=i,e[i]=e[i]||function(){(e[i].q=e[i].q||[]).push(arguments)},e[i].l=1*new Date,a=t.createElement(o),n=t.getElementsByTagName(o)[0],a.async=1,a.src=c,a.charset="utf-8",n.parentNode.insertBefore(a,n)}(window,document,"script",("https:"==document.location.protocol?"https:":"http:")+"//widget.daovoice.io/widget/e6b7efdb.js","daovoice"),daovoice("init",{app_id:"e6b7efdb"}),daovoice("update")</script><meta name="baidu-site-verification" content="true"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.ico?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.ico?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="RabbitMQ"><link rel="alternate" href="/atom.xml" title="Du.Jiang" type="application/atom+xml"><meta name="keywords" content="RabbitMQ"><meta property="og:type" content="article"><meta property="og:title" content="RabbitMQ超详细教程"><meta property="og:url" content="https://www.amorou.cn/2017-03-21/RabbitMQ超详细教程.html"><meta property="og:site_name" content="Du.Jiang"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://www.amorou.cn/2017-03-21/images/cover/RabbitMQ.png"><meta property="og:updated_time" content="2019-08-11T00:53:48.636Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="RabbitMQ超详细教程"><meta name="twitter:image" content="https://www.amorou.cn/2017-03-21/images/cover/RabbitMQ.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Mist",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="https://www.amorou.cn/2017-03-21/RabbitMQ超详细教程.html"><title>RabbitMQ超详细教程 | Du.Jiang</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">Du.Jiang</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i><br>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://www.amorou.cn/2017-03-21/RabbitMQ超详细教程.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Du.Jiang"><meta itemprop="description" content><meta itemprop="image" content="/images/avatar.png"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Du.Jiang"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">RabbitMQ超详细教程</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-03-21T13:18:31+08:00">2017-03-21 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/RabbitMQ/" itemprop="url" rel="index"><span itemprop="name">RabbitMQ</span> </a></span></span><span class="post-comments-count"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-comment-o"></i> </span><a href="/2017-03-21/RabbitMQ超详细教程.html#comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2017-03-21/RabbitMQ超详细教程.html" itemprop="commentCount"></span></a></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">13.8k </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">61</span></div></div></header><div class="post-body" itemprop="articleBody"><div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery"><div class="post-gallery-row"><a class="post-gallery-img" style="cursor:default" href="javascript:void(0)" rel="gallery_cjz6co8sy002h0cvh088lsi6w" itemscope itemtype="http://schema.org/ImageObject" itemprop="url"><img src="/./images/cover/RabbitMQ.png" itemprop="contentUrl"></a></div></div><a id="more"></a><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><h2 id="1、为什么使用RabbitMQ"><a href="#1、为什么使用RabbitMQ" class="headerlink" title="1、为什么使用RabbitMQ"></a>1、为什么使用RabbitMQ</h2><p><strong>为什么我开始选择学习RabbitMQ：</strong></p><ol><li>安装部署简单，上手门槛低，功能丰富，符合AMQP标准；</li><li>企业级消息队列，经过大量实践考验的高可靠；</li><li>集群易扩展，可以轻松的增减集群节点；</li><li>有强大的WEB管理页面。</li></ol><p><strong>企业为什么将RabbitMQ作为消息队列系统：</strong></p><p><strong>十万米高空看RabbitMQ：</strong></p><ol><li>有商业化的运营，不会轻易死掉；</li><li>遵循AMQP协议，不会被绑架；</li><li>强大的社区支持，为技术进步提供动力；</li><li>大量成功的应用案例，例如阿里、网易等互联网巨头都有使用。</li></ol><p><strong>显微镜看RabbitMQ：</strong></p><ol><li>Erlang开发，AMQP的最佳搭档，在支持持久化的消息队列中性能算很优秀的；</li><li>支持消息持久化、支持消息确认机制、灵活的任务分发机制等，支持功能非常丰富；</li><li>可靠性高；</li><li>集群扩展很容易，并且可以通过增加节点实现成倍的性能提升；</li><li>WEB管理和监控，有些技术癌更喜欢命令行界面，但WEB管理为后期运维提供很大的便利。</li><li>RabbitMQ劣势： 在kafka和zero面前性能被虐成渣，（持久化消息和ACK确认的情况下生产和消费消息单机大约在1-2万左右）</li></ol><p><strong>结论：如果你希望使用一个可靠性高、功能强大、易于管理的消息队列系统那么就选择RabbitMQ吧，如果你想用一个性能高，但偶尔丢点数据不是很在乎可以使用kafka或者zeroMQ。</strong></p><h2 id="2、RabbitMQ产生的背景"><a href="#2、RabbitMQ产生的背景" class="headerlink" title="2、RabbitMQ产生的背景"></a>2、RabbitMQ产生的背景</h2><p>1、消息队列系统最在可以追溯到上个世纪。1983年最早的消息队列软件Teknekron诞生，当时紧用于一些金融交易等系统。</p><p>2、上世纪九十年代，诞生了多家消息队列系统，例如IBM MQ、微软的MSMQ、TIBCO MQ等消息队列在企业中的应用也愈加广泛。显然这些商用的消息队列系统如果企业要使用需要付出高昂的成本，并且各个消息队列之间使用不同的API不同的协议。</p><p>3、2004年，AMQP（Advanced Message Queuing Protocol,高级消息队列协议）开始开发。通过这一标准可以和任意AMQP供应商提供的MQ服务进行交互。</p><p>4、2006年，光阴荏苒时光如梭，一转眼就说到了重点。我们的主角使用Erlang语言实现的AMQP开源版本，RabbitMQ诞生了，同年AMQP协议首次发布。</p><h2 id="3、为什么叫RabbitMQ？"><a href="#3、为什么叫RabbitMQ？" class="headerlink" title="3、为什么叫RabbitMQ？"></a>3、为什么叫RabbitMQ？</h2><p>兔子行动非常迅速而且繁殖起来也非常疯狂，所以就把Rabbit用作这个分布式软件的命名（就是这么简单）。</p><h1 id="一、RabbitMQ的安装"><a href="#一、RabbitMQ的安装" class="headerlink" title="一、RabbitMQ的安装"></a>一、RabbitMQ的安装</h1><p>全文讲解的是在winodws10下的安装使用</p><h2 id="1、下载安装erlang"><a href="#1、下载安装erlang" class="headerlink" title="1、下载安装erlang"></a>1、下载安装erlang</h2><p>下载erlang，原因在于RabbitMQ服务端代码是使用并发式语言erlang编写的，下载地址：<a href="http://www.erlang.org/downloads" target="_blank" rel="noopener"><em>http://www.erlang.org/downloads</em></a>，双击.exe文件进行安装就好。</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553595811567.png" alt="1553595811567"></p><p>下载完成后双击打开，一直next就可以，不再描述</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553595853833.png" alt="1553595853833"></p><p>安装完成之后创建一个名为ERLANG_HOME的环境变量，其值指向erlang的安装目录。同将<code>%ERLANG_HOME%\bin</code>加入到Path中</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553595874152.png" alt="1553595874152"></p><p>最后打开命令行，输入erl，如果出现erlang的版本信息就表示erlang语言环境安装成功。</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553595888912.png" alt="1553595888912"></p><h2 id="2、下载安装RabbitMQ"><a href="#2、下载安装RabbitMQ" class="headerlink" title="2、下载安装RabbitMQ"></a>2、下载安装RabbitMQ</h2><p>点击<a href="https://www.rabbitmq.com/download.html" target="_blank" rel="noopener"><em>RabbitMQ官网下载地址</em></a>，进入下载页面：</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553595935526.png" alt="1553595935526"></p><p>选择对应的下载链接：</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553595944109.png" alt="1553595944109"></p><p>安装路径不能有空格，默认的安装路径是有空格的，请注意：3.7.4之后版本是无需理会安装空格的。</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553595951886.png" alt="1553595951886"></p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553595956541.png" alt="1553595956541"></p><h2 id="3、激活-RabbitMQ’s-Management-Plugin"><a href="#3、激活-RabbitMQ’s-Management-Plugin" class="headerlink" title="3、激活 RabbitMQ’s Management Plugin"></a>3、激活 RabbitMQ’s Management Plugin</h2><p>安装RabbitMQ-Plugins，这个相当于是一个管理界面，方便我们在浏览器界面查看RabbitMQ各个消息队列以及exchange的工作情况。进入RabbitMQ的安装目录并以<strong>管理员身份</strong>运行cmd命令：</p><p>输入指令激活插件：<strong>rabbitmq-plugins.bat enable rabbitmq_management</strong></p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553595977845.png" alt="1553595977845"></p><p>​ 输入指令启动RabbitMQ服务：<strong>net start RabbitMQ</strong></p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553595985023.png" alt="1553595985023"></p><p>常用命令：</p><blockquote><p>启动服务：net start RabbitMQ</p><p>停止服务：net stop RabbitMQ</p><p>重启服务：net stop RabbitMQ &amp;&amp; net start RabbitMQ</p></blockquote><h2 id="4、登录验证"><a href="#4、登录验证" class="headerlink" title="4、登录验证"></a>4、登录验证</h2><p>浏览器访问：<a href="http://localhost:15672" target="_blank" rel="noopener"><em>http://localhost:15672</em></a>，默认用户名和密码：guest</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553596005404.png" alt="1553596005404"></p><h2 id="5、配置允许远程访问"><a href="#5、配置允许远程访问" class="headerlink" title="5、配置允许远程访问"></a>5、配置允许远程访问</h2><p>更多情况下，队列服务往往不在我们本机上，我们需要远程来控制RabbitMQ，但是默认是无法通过<strong><a href="http://server-name:15672" target="_blank" rel="noopener">http://server-name:15672</a></strong>来访问的，可以通过修改<strong>\RabbitMQ Server\rabbitmq_server-3.6.10\etc</strong>下<strong>Rabbitmq.config</strong>来设置允许guest用户远程登录，具体修改为如下，然后就到服务管理器中重启RabbitMQ服务。</p><p>默认RabbitMQ会在<strong>C:\Users\Administrator\AppData\Roaming\RabbitMQ</strong> 中生成一个配置文件，<strong>rabbitmq.config</strong> 里面就是实际用到的配置信息，如果图方便，也可以这里直接改。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&#123;rabbit, [&#123;loopback_users, [guest]&#125;]&#125;].</span><br></pre></td></tr></table></figure><h1 id="二、RabbitMQ概念"><a href="#二、RabbitMQ概念" class="headerlink" title="二、RabbitMQ概念"></a>二、RabbitMQ概念</h1><ul><li><p>producer：消息生产者</p></li><li><p>consumer：消息消费者</p></li><li><p>virtual host：虚拟主机，在RabbitMQ中，用户只能在虚拟主机的层面上进行一些权限设置，比如我可以访问哪些队列，我可以处理哪些请求等等；</p></li><li><p>broker：消息转发者，也就是我们RabbitMQ服务端充当的功能了，那么消息是按照什么规则进行转发的呢？需要用到下面几个概念；</p></li><li><p>exchange：交换机，他是和producer直接进行打交道的，有点类似于路由器的功能，主要就是进行转发操作的呗，那么producer到底用哪个exchange进行路由呢？这个取决于routing key(路由键)，每个消息都有这个键，我们也可以自己设定，其实就是一字符串；</p></li><li><p>queue：消息队列，用于存放消息，他接收exchange路由过来的消息，我们可以对队列内容进行持久化操作，那么queue到底接收那个exchange路由的消息呢？这个时候就要用到binding key(绑定键)了，绑定键会将队列和exchange进行绑定，至于绑定方式，RabbitMQ提供了多种方式；</p></li></ul><p>以上就是RabbitMQ涉及到的一些概念了，用一张图表示这些概念之间的关系就是：</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553596062355.png" alt="1553596062355"></p><h1 id="三、用户角色权限、virtual-hosts配置"><a href="#三、用户角色权限、virtual-hosts配置" class="headerlink" title="三、用户角色权限、virtual hosts配置"></a>三、用户角色权限、virtual hosts配置</h1><h2 id="1、用户管理"><a href="#1、用户管理" class="headerlink" title="1、用户管理"></a>1、用户管理</h2><p>​ 我们在开发的时候一般不直接使用guest账号进行操作，而是新增一个新的管理用户进行操作，那么怎么新增帐号呢？</p><ol><li><p>首先使用guest帐号登录管理控制台</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553596113270.png" alt="1553596113270"></p></li><li><p>如上图点击<strong>Admin</strong>菜单并点击<strong>Add a user</strong>操作就会出现用户名和密码以及确认密码、<strong>Tags</strong>（相当于角色）的输入框。输入后点击左下方的<strong>Add user</strong>按钮即可完成新增用户的操作，新增成功后会在<strong>Admin</strong>页面列表中出现我们新增的用户。</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553596129491.png" alt="1553596129491"></p></li></ol><h2 id="2、角色管理"><a href="#2、角色管理" class="headerlink" title="2、角色管理"></a>2、角色管理</h2><p>RabbitMQ中的角色分为如下五类：none、management、policymaker、monitoring、administrator</p><ul><li><p>none ：</p><p>不能访问 management plugin</p></li><li><p>management ：</p><p>用户可以通过AMQP做的任何事外加：</p><p>列出自己可以通过AMQP登入的virtual hosts</p><p>查看自己的virtual hosts中的queues, exchanges 和 bindings</p><p>查看和关闭自己的channels 和 connections</p><p>查看有关自己的virtual hosts的“全局”的统计信息，包含其他用户在这些virtual hosts中的活动。</p></li><li><p>policymaker ：</p><p>management可以做的任何事外加： 查看、创建和删除自己的virtual hosts所属的policies和parameters</p></li><li><p>monitoring ：</p><p>management可以做的任何事外加：</p><p>​ 列出所有virtual hosts，包括他们不能登录的virtual hosts</p><p>​ 查看其他用户的connections和channels</p><p>​ 查看节点级别的数据如clustering和memory使用情况</p><p>​ 查看真正的关于所有virtual hosts的全局的统计信息</p></li><li><p>administrator ：</p><p>policymaker和monitoring可以做的任何事外加:</p><p>​ 创建和删除virtual hosts</p><p>​ 查看、创建和删除users</p><p>​ 查看创建和删除permissions</p><p>​ 关闭其他用户的connections</p></li></ul><h2 id="3、virtual-hosts"><a href="#3、virtual-hosts" class="headerlink" title="3、virtual hosts"></a>3、virtual hosts</h2><p>像mysql有数据库的概念并且可以指定用户对库和表等操作的权限。那RabbitMQ呢？RabbitMQ也有类似的权限管理。在RabbitMQ中可以虚拟消息服务器VirtualHost，每个VirtualHost相当月一个相对独立的RabbitMQ服务器，每个VirtualHost之间是相互隔离的。exchange、queue、message不能互通。</p><p>在RabbitMQ中无法通过AMQP创建VirtualHost，可以通过以下命令来创建。</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553596315130.png" alt="1553596315130"></p><p>如上图在创建完vhost后可以在All Virtual Host标签看到新建的VirtualHost。</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553596339805.png" alt="1553596339805"></p><h2 id="4、virtual-hosts授权"><a href="#4、virtual-hosts授权" class="headerlink" title="4、virtual hosts授权"></a>4、virtual hosts授权</h2><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553596348575.png" alt="1553596348575"></p><p>在用户列表界面点击我们需要授权的用户，出现如下界面：</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553596356642.png" alt="1553596356642"></p><p>然后选择指定的Virtual Host进行授权，授权完成后我们回到Admin页面如下：</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553596365503.png" alt="1553596365503"></p><h1 id="四、RabbitMQ-简单队列"><a href="#四、RabbitMQ-简单队列" class="headerlink" title="四、RabbitMQ - 简单队列"></a>四、RabbitMQ - 简单队列</h1><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553596376129.png" alt="1553596376129"></p><p>一个生产者对应一个消费者！！！</p><p>生产者将消息发送到“hello”队列。消费者从该队列接收消息。</p><p>接下来我们将用Java编写两个程序;发送单个消息的生产者，以及接收消息并将其打印出来的消费者。</p><p>1、新建Maven项目，添加RabbitMQ客户端和 (<a href="http://central.maven.org/maven2/org/slf4j/slf4j-api/1.7.25/slf4j-api-1.7.25.jar" target="_blank" rel="noopener">SLF4J API</a> and <a href="http://central.maven.org/maven2/org/slf4j/slf4j-simple/1.7.25/slf4j-simple-1.7.25.jar" target="_blank" rel="noopener">SLF4J Simple</a>)的依赖包</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.dj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rabbitmq<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>rabbitmq<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">jdk.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">jdk.version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rabbitmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>amqp-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>5.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-nop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.26<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">finalName</span>&gt;</span>rabbitmq<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">source</span>&gt;</span>$&#123;jdk.version&#125;<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">target</span>&gt;</span>$&#123;jdk.version&#125;<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p>2、创建获取连接工具类：ConnectionUtils.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectionUtils</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		<span class="comment">//1、定义连接工厂</span></span><br><span class="line">		ConnectionFactory connectionFactory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">		<span class="comment">//2、设置服务器地址</span></span><br><span class="line">		connectionFactory.setHost(<span class="string">"127.0.0.1"</span>);</span><br><span class="line">		<span class="comment">//3、设置端口</span></span><br><span class="line">		connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">		<span class="comment">//4、设置VirtualHost、用户名及密码</span></span><br><span class="line">		connectionFactory.setVirtualHost(<span class="string">"/virtual_test"</span>);</span><br><span class="line">		connectionFactory.setUsername(<span class="string">"djtest"</span>);</span><br><span class="line">		connectionFactory.setPassword(<span class="string">"djtest"</span>);</span><br><span class="line">		<span class="comment">//5、获取并返回连接</span></span><br><span class="line">		<span class="keyword">return</span> connectionFactory.newConnection();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3、创建消息发送者：Send.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义队列名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"simple_queue"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		<span class="comment">//1、获取连接</span></span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		<span class="comment">//2、声明信道</span></span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//3、声明(创建)队列</span></span><br><span class="line">		channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">		<span class="comment">//4、定义消息内容</span></span><br><span class="line">		String message = <span class="string">"Hello World!"</span>;</span><br><span class="line">		<span class="comment">//5、发布消息</span></span><br><span class="line">		channel.basicPublish(<span class="string">""</span>, QUEUE_NAME, <span class="keyword">null</span>, message.getBytes(<span class="string">"UTF-8"</span>));</span><br><span class="line">		System.out.println(<span class="string">"[x] Sent'"</span> + message + <span class="string">"'"</span>);</span><br><span class="line">		<span class="comment">//6、关闭通道</span></span><br><span class="line">		channel.close();</span><br><span class="line">		<span class="comment">//7、关闭连接</span></span><br><span class="line">		connection.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时我们直接运行消费者的main方法，结果如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[x] Sent&apos;Hello World!&apos;</span><br></pre></td></tr></table></figure><p>查看管理界面Queue页面结果如下：</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553596502939.png" alt="1553596502939"></p><p>4、创建消息消费者：Recv.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DefaultConsumer;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Envelope;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.AMQP.BasicProperties;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义队列名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"simple_queue"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		<span class="comment">//1、获取连接</span></span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		<span class="comment">//2、声明信道</span></span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//3、声明队列</span></span><br><span class="line">		channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">		<span class="comment">//4、定义队列的消费者</span></span><br><span class="line">		DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">				<span class="comment">//6、获取消息</span></span><br><span class="line">				System.out.println(<span class="keyword">new</span> String(body, <span class="string">"utf-8"</span>));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="comment">//5、监听队列</span></span><br><span class="line">		channel.basicConsume(QUEUE_NAME, <span class="keyword">true</span>, consumer);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>消费者代码编写完成后运行，控制台打印结果如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hello World!</span><br></pre></td></tr></table></figure><p>查看管理界面Queue页面结果会发现我们之前发布的消息已经被消费：</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553596559895.png" alt="1553596559895"></p><h1 id="五、RabbitMQ-–-Work-Queue（工作队列）"><a href="#五、RabbitMQ-–-Work-Queue（工作队列）" class="headerlink" title="五、RabbitMQ – Work Queue（工作队列）"></a>五、RabbitMQ – Work Queue（工作队列）</h1><h2 id="1、Round-robin-dispatching（轮询分发）"><a href="#1、Round-robin-dispatching（轮询分发）" class="headerlink" title="1、Round-robin dispatching（轮询分发）"></a>1、Round-robin dispatching（轮询分发）</h2><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553596583343.png" alt="1553596583343"></p><p>一个生产者对应多个消费者，但是只能有一个消费者获得消息！！！</p><p>竞争消费者模式。</p><p>接下来用Java编写两个程序;发送单个消息的生产者，以及接收消息并将其打印出来的多个消费者。</p><h3 id="1、创建消息发送者：Send-java"><a href="#1、创建消息发送者：Send-java" class="headerlink" title="1、创建消息发送者：Send.java"></a>1、创建消息发送者：Send.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义队列名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"work_queue"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException, InterruptedException </span>&#123;</span><br><span class="line">		<span class="comment">//1、获取连接</span></span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		<span class="comment">//2、声明信道</span></span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//3、声明(创建)队列</span></span><br><span class="line">		channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">		<span class="comment">//4、定义消息内容(发布多条消息)</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">			String message = <span class="string">"I am work_queue "</span> + i;</span><br><span class="line">			<span class="comment">//5、发布消息</span></span><br><span class="line">			channel.basicPublish(<span class="string">""</span>, QUEUE_NAME, <span class="keyword">null</span>, message.getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">			System.out.println(<span class="string">" [x] Sent '"</span> + message + <span class="string">"'"</span>);</span><br><span class="line">			<span class="comment">//模拟发送消息延时，便于演示多个消费者竞争接受消息</span></span><br><span class="line">			Thread.sleep(i * <span class="number">10</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//6、关闭信道</span></span><br><span class="line">		channel.close();</span><br><span class="line">		<span class="comment">//7、关闭连接</span></span><br><span class="line">		connection.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、创建消息消费者1：Recv-1-java"><a href="#2、创建消息消费者1：Recv-1-java" class="headerlink" title="2、创建消息消费者1：Recv_1.java"></a>2、创建消息消费者1：Recv_1.java</h3><p>每接收一条消息后休眠10毫秒</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DefaultConsumer;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Envelope;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.AMQP.BasicProperties;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv_1</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义队列名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"work_queue"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		<span class="comment">//1、获取连接</span></span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		<span class="comment">//2、声明信道</span></span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//3、声明队列</span></span><br><span class="line">		channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">		<span class="comment">//4、定义队列的消费者</span></span><br><span class="line">		DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">				<span class="comment">//6、获取消息</span></span><br><span class="line">				System.out.println(<span class="keyword">new</span> String(body, <span class="string">"utf-8"</span>));</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					Thread.sleep(<span class="number">10</span>);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="comment">//5、监听队列</span></span><br><span class="line">		channel.basicConsume(QUEUE_NAME, <span class="keyword">true</span>, consumer);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3、创建消息消费者2：Recv-2-java"><a href="#3、创建消息消费者2：Recv-2-java" class="headerlink" title="3、创建消息消费者2：Recv_2.java"></a>3、创建消息消费者2：Recv_2.java</h3><p>每接收一条消息后休眠1000毫秒</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DefaultConsumer;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Envelope;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.AMQP.BasicProperties;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv_2</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义队列名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"work_queue"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		<span class="comment">//1、获取连接</span></span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		<span class="comment">//2、声明信道</span></span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//3、声明队列</span></span><br><span class="line">		channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">		<span class="comment">//4、定义队列的消费者</span></span><br><span class="line">		DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">				<span class="comment">//6、获取消息</span></span><br><span class="line">				System.out.println(<span class="keyword">new</span> String(body, <span class="string">"utf-8"</span>));</span><br><span class="line">				<span class="comment">//消费者2接收一条消息后休眠1000毫秒</span></span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="comment">//5、监听队列</span></span><br><span class="line">		channel.basicConsume(QUEUE_NAME, <span class="keyword">true</span>, consumer);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>4、测试结果</p><p><strong>生产者一次打印从0-9条消息</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[x] Sent &apos;I am work_queue 0&apos;</span><br><span class="line">[x] Sent &apos;I am work_queue 1&apos;</span><br><span class="line">[x] Sent &apos;I am work_queue 2&apos;</span><br><span class="line">[x] Sent &apos;I am work_queue 3&apos;</span><br><span class="line">[x] Sent &apos;I am work_queue 4&apos;</span><br><span class="line">[x] Sent &apos;I am work_queue 5&apos;</span><br><span class="line">[x] Sent &apos;I am work_queue 6&apos;</span><br><span class="line">[x] Sent &apos;I am work_queue 7&apos;</span><br><span class="line">[x] Sent &apos;I am work_queue 8&apos;</span><br><span class="line">[x] Sent &apos;I am work_queue 9&apos;</span><br></pre></td></tr></table></figure><p><strong>消费者1：结果为打印偶数条消息</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">I am work_queue 0</span><br><span class="line">I am work_queue 2</span><br><span class="line">I am work_queue 4</span><br><span class="line">I am work_queue 6</span><br><span class="line">I am work_queue 8</span><br></pre></td></tr></table></figure><p><strong>消费者2：结果为打印奇数条消息</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">I am work_queue 1</span><br><span class="line">I am work_queue 3</span><br><span class="line">I am work_queue 5</span><br><span class="line">I am work_queue 7</span><br><span class="line">I am work_queue 9</span><br></pre></td></tr></table></figure><h3 id="5、分析结果"><a href="#5、分析结果" class="headerlink" title="5、分析结果"></a>5、分析结果</h3><p><strong>消费者1和消费者2获取到的消息内容是不同的，也就是说同一个消息只能被一个消费者获取。</strong></p><p><strong>消费者1和消费者2分别获取奇数条消息和偶数条消息，两种获取消息的条数是一样的。</strong></p><p>前面我们说这种模式是竞争消费者模式，一条队列被多个消费者监听，这里两个消费者，其中消费者1和消费者2在获取消息后分别休眠了10毫秒和1000毫秒，也就是说两个消费者获取消息的效率是不一样的，但是结果却是两者获得的消息条数是一样的，这根本就不构成竞争关系，那么我们应该怎么办才能让工作效率高的消费者获取消息更多，也就是消费者1获取消息更多呢？</p><p>PS：在增加一个消费者其实获取消息条数也是一样的，消费者1获取0、3、6、9，消费者2获取1、4、7，消费者3获取2、5、8</p><p>每个消费者将获得相同数量的消息。这种分发消息的方式称为循环法。</p><h2 id="2、Fair-dispatch（公平分发）"><a href="#2、Fair-dispatch（公平分发）" class="headerlink" title="2、Fair dispatch（公平分发）"></a>2、Fair dispatch（公平分发）</h2><p>根据结果分析我们得知，如果，我们单个消费者1分钟最多处理60条消息，但是，生产者1分钟可能会发送300条消息，如果，我们一台消费者客户端，1分钟同时要接收到300条消息，已经超过我们最大的负载，这时，就可能导致，服务器资源被耗尽，消费者客户端卡死等情况。然而，RabbitMQ对此却一无所知，仍然会均匀的发送消息。</p><p>发生这种情况是因为RabbitMQ只是在消息进入队列时调度消息。它不会查看消费者未确认消息的数量。它只会盲目的把第n个消息发送给第n个消费者。</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553596764194.png" alt="1553596764194"></p><p>为了改变这种模式，RabbitMQ提供了一种qos（服务质量保证）功能，即在非自动确认消息的前提下，如果一定数目的消息（通过基于consume或者channel设置Qos的值）未被确认前，不进行消费新的消息。</p><p>我们可以使用basicQos方法和prefetchCount = 1设置。这告诉RabbitMQ在处理并确认前一个消息之前，不要向该消费者发送新消息，它会将它发送给下一个仍然很忙的工人。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">com.rabbitmq.client.Channel：</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">basicQos</span><span class="params">(<span class="keyword">int</span> prefetchCount)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">basicQos</span><span class="params">(<span class="keyword">int</span> prefetchCount, <span class="keyword">boolean</span> global)</span> <span class="keyword">throws</span> IOException</span>;   </span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">basicQos</span><span class="params">(<span class="keyword">int</span> prefetchSize, <span class="keyword">int</span> prefetchCount, <span class="keyword">boolean</span> global)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// prefetchSize：服务器将传递的最大内容量（以八位字节为单位），如果不受限制，则为0</span></span><br><span class="line"><span class="comment">// prefetchCount：服务器将传递的最大消息数，如果不受限制，则为0，简单点说，就是会告诉RabbitMQ不要同时给一个消费者推送多于N个消息，即一旦有N个消息还没有ack，则该consumer将block掉，直到有消息ack</span></span><br><span class="line"><span class="comment">// global：true\false 是否将上面设置应用于channel，简单点说，就是上面限制是channel级别的还是consumer级别</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> prefetchCount = <span class="number">1</span> ; </span><br><span class="line">channel.basicQos（prefetchCount）;</span><br></pre></td></tr></table></figure><p>生产者和消费者同时增加如上代码，表示同一时刻服务器只会发送一条消息给消费者。发现消费者1和消费者2获取消息结果还是如之前那样，这是为什么呢，是因为prefetchCount在autoAsk=false的情况下生效，即在自动应答的情况下这两个值是不生效的，而我们之前的消费端代码是使用的自动应答模式。</p><h3 id="1、创建消息发送者：Send-java-1"><a href="#1、创建消息发送者：Send-java-1" class="headerlink" title="1、创建消息发送者：Send.java"></a>1、创建消息发送者：Send.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义队列名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"work_queue_fair"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException, InterruptedException </span>&#123;</span><br><span class="line">		<span class="comment">//1、获取连接</span></span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		<span class="comment">//2、声明信道</span></span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//3、声明(创建)队列</span></span><br><span class="line">		channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">		<span class="comment">//4、限制每个消费者同时最多能处理1条消息</span></span><br><span class="line">		<span class="keyword">int</span> prefetchCount = <span class="number">1</span>;</span><br><span class="line">		channel.basicQos(prefetchCount);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//5、定义消息内容(发布多条消息)</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">			String message = <span class="string">"I am work_queue "</span> + i;</span><br><span class="line">			<span class="comment">//6、发布消息</span></span><br><span class="line">			channel.basicPublish(<span class="string">""</span>, QUEUE_NAME, <span class="keyword">null</span>, message.getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">			System.out.println(<span class="string">" [x] Sent '"</span> + message + <span class="string">"'"</span>);</span><br><span class="line">			<span class="comment">//模拟发送消息延时，便于演示多个消费者竞争接受消息</span></span><br><span class="line">			Thread.sleep(i * <span class="number">10</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//7、关闭信道</span></span><br><span class="line">		channel.close();</span><br><span class="line">		<span class="comment">//8、关闭连接</span></span><br><span class="line">		connection.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2、创建消息消费者1：Recv-1-java-1"><a href="#2、创建消息消费者1：Recv-1-java-1" class="headerlink" title="2、创建消息消费者1：Recv_1.java"></a>2、创建消息消费者1：Recv_1.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DefaultConsumer;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Envelope;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.AMQP.BasicProperties;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv_1</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义队列名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"work_queue_fair"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		<span class="comment">//1、获取连接</span></span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		<span class="comment">//2、声明信道</span></span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//3、声明队列</span></span><br><span class="line">		channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">		<span class="comment">//4、保证一次只处理一个</span></span><br><span class="line">		<span class="keyword">int</span> prefetchCount = <span class="number">1</span>;</span><br><span class="line">		channel.basicQos(prefetchCount);</span><br><span class="line">		<span class="comment">//5、定义队列的消费者</span></span><br><span class="line">		DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">				<span class="comment">//7、获取消息</span></span><br><span class="line">				System.out.println(<span class="keyword">new</span> String(body, <span class="string">"utf-8"</span>));</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="comment">//消费者1接收一条消息后休眠10毫秒</span></span><br><span class="line">					Thread.sleep(<span class="number">10</span>);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">					<span class="comment">//手动应答</span></span><br><span class="line">					channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="comment">//6、监听队列-关闭自动应答</span></span><br><span class="line">		<span class="keyword">boolean</span> autoAck = <span class="keyword">false</span>;</span><br><span class="line">		channel.basicConsume(QUEUE_NAME, autoAck, consumer);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3、创建消息消费者2：Recv-2-java-1"><a href="#3、创建消息消费者2：Recv-2-java-1" class="headerlink" title="3、创建消息消费者2：Recv_2.java"></a>3、创建消息消费者2：Recv_2.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DefaultConsumer;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Envelope;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.AMQP.BasicProperties;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv_2</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义队列名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"work_queue_fair"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		<span class="comment">//1、获取连接</span></span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		<span class="comment">//2、声明信道</span></span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//3、声明队列</span></span><br><span class="line">		channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">		<span class="comment">//4、保证一次只处理一个</span></span><br><span class="line">		<span class="keyword">int</span> prefetchCount = <span class="number">1</span>;</span><br><span class="line">		channel.basicQos(prefetchCount);</span><br><span class="line">		<span class="comment">//5、定义队列的消费者</span></span><br><span class="line">		DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">				<span class="comment">//7、获取消息</span></span><br><span class="line">				System.out.println(<span class="keyword">new</span> String(body, <span class="string">"utf-8"</span>));</span><br><span class="line">				<span class="comment">//消费者2接收一条消息后休眠1000毫秒</span></span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">					<span class="comment">//手动应答</span></span><br><span class="line">					channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="comment">//6、监听队列-关闭自动应答</span></span><br><span class="line">		<span class="keyword">boolean</span> autoAck = <span class="keyword">false</span>;</span><br><span class="line">		channel.basicConsume(QUEUE_NAME, autoAck, consumer);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4、测试结果"><a href="#4、测试结果" class="headerlink" title="4、测试结果"></a>4、测试结果</h3><p><strong>生产者一次打印从0-9条消息</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[x] Sent &apos;I am work_queue 0&apos;</span><br><span class="line">[x] Sent &apos;I am work_queue 1&apos;</span><br><span class="line">[x] Sent &apos;I am work_queue 2&apos;</span><br><span class="line">[x] Sent &apos;I am work_queue 3&apos;</span><br><span class="line">[x] Sent &apos;I am work_queue 4&apos;</span><br><span class="line">[x] Sent &apos;I am work_queue 5&apos;</span><br><span class="line">[x] Sent &apos;I am work_queue 6&apos;</span><br><span class="line">[x] Sent &apos;I am work_queue 7&apos;</span><br><span class="line">[x] Sent &apos;I am work_queue 8&apos;</span><br><span class="line">[x] Sent &apos;I am work_queue 9&apos;</span><br></pre></td></tr></table></figure><p><strong>消费者1</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">I am work_queue 0</span><br><span class="line">I am work_queue 2</span><br><span class="line">I am work_queue 3</span><br><span class="line">I am work_queue 4</span><br><span class="line">I am work_queue 5</span><br><span class="line">I am work_queue 6</span><br><span class="line">I am work_queue 7</span><br><span class="line">I am work_queue 8</span><br><span class="line">I am work_queue 9</span><br></pre></td></tr></table></figure><p><strong>消费者2</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">I am work_queue 1</span><br></pre></td></tr></table></figure><h3 id="5、应用场景"><a href="#5、应用场景" class="headerlink" title="5、应用场景"></a>5、应用场景</h3><p>效率高的消费者消费消息多。可以用来进行负载均衡。</p><p><strong>PS：如果所有消费者都很忙，队列就会填满。那么将需要考虑添加更多消费者，或者创建更多的virtualHost来细化你的设计，或者采取其他策略。</strong></p><h1 id="六、Exchanges（交换机）"><a href="#六、Exchanges（交换机）" class="headerlink" title="六、Exchanges（交换机）"></a>六、Exchanges（交换机）</h1><p>交换器分为四种，分别是：direct、fanout、topic和 headers。</p><p>前面三种分别对应路由模式、发布订阅模式和通配符模式，headers 交换器允许匹配 AMQP 消息的 header 而非路由键，除此之外，header 交换器和 direct 交换器完全一致，但是性能却差很多，因此基本上不会用到该交换器，这里也不详细介绍。</p><h2 id="1、direct"><a href="#1、direct" class="headerlink" title="1、direct"></a>1、direct</h2><p>如果路由键完全匹配的话，消息才会被投放到相应的队列。</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553596975661.png" alt="1553596975661"></p><p>direct是RabbitMQ默认的交换机模式，也是最简单的模式，根据key全文匹配去寻找队列。</p><h2 id="2、fanout"><a href="#2、fanout" class="headerlink" title="2、fanout"></a>2、fanout</h2><p>当发送一条消息到fanout交换器上时，它会把消息投放到所有附加在此交换器上的队列。</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553596990106.png" alt="1553596990106"></p><p>不处理路由键。你只需要简单的将队列绑定到交换机上。一个发送到交换机的消息都会被转发到与该交换机绑定的所有队列上。很像子网广播，每台子网内的主机都获得了一份复制的消息。Fanout交换机转发消息是最快的。</p><p>发送消息，只需要指定交换机，route key 可以为空</p><h2 id="3、topic"><a href="#3、topic" class="headerlink" title="3、topic"></a>3、topic</h2><p>设置模糊的绑定方式，“*”操作符将“.”视为分隔符，匹配单个字符；“#”操作符没有分块的概念，它将任意“.”均视为关键字的匹配部分，能够匹配多个字符。</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553597009104.png" alt="1553597009104"></p><h1 id="七、RabbitMQ-–-Publish-Subscribe（发布-订阅模式）"><a href="#七、RabbitMQ-–-Publish-Subscribe（发布-订阅模式）" class="headerlink" title="七、RabbitMQ – Publish/Subscribe（发布/订阅模式）"></a>七、RabbitMQ – Publish/Subscribe（发布/订阅模式）</h1><p>在之前的案例中都是同一个消息都只能被一个消费者消费，如果现在同一个消息需要向多个消费者传递信息，那么就需要使用到Publish/Subscribe（发布/订阅）。</p><p>以下构建一个注册成功后发送邮件和短信通知的例子。</p><p>RabbitMQ中消息传递模型的核心思想是生产者永远不会将任何消息直接发送到队列。实际上，生产者通常甚至不知道消息是否会被传递到任何队列。</p><p>相反，生产者只能向exchange（交换机）发送消息。exchange一方面接收来自生产者的消息，另一方面将它们推送到队列。exchange必须确切知道如何处理它收到的消息。它应该附加到特定队列吗？它应该附加到许多队列吗？或者它应该被丢弃。其规则由交换类型定义 。</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553597038735.png" alt="1553597038735"></p><p>在RabbitMQ中有几种交换类型可供选择：<code>direct</code>、<code>topic</code>、<code>headers</code>、<code>fanout</code>，接下来的列子我们讲使用“<code>fanout</code>”这种类型，并将其称为 “<code>fanout_exchange</code>”。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">channel.exchangeDeclare(<span class="string">"fanout_exchange"</span>, <span class="string">"fanout"</span>);</span><br></pre></td></tr></table></figure><h2 id="1、创建消息发送者：Send-java-2"><a href="#1、创建消息发送者：Send-java-2" class="headerlink" title="1、创建消息发送者：Send.java"></a>1、创建消息发送者：Send.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义交换机名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME = <span class="string">"fanout_exchange"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		<span class="comment">//1、获取连接</span></span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		<span class="comment">//2、声明信道</span></span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//3、声明交换机</span></span><br><span class="line">		channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">"fanout"</span>);</span><br><span class="line">		<span class="comment">//4、定义消息内容</span></span><br><span class="line">		String message = <span class="string">"注册成功"</span>;</span><br><span class="line">		<span class="comment">//5、发布消息</span></span><br><span class="line">		channel.basicPublish(EXCHANGE_NAME, <span class="string">""</span>, <span class="keyword">null</span>, message.getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">		System.out.println(<span class="string">" [x] Sent '"</span> + message + <span class="string">"'"</span>);</span><br><span class="line">		<span class="comment">//6、关闭信道</span></span><br><span class="line">		channel.close();</span><br><span class="line">		<span class="comment">//7、关闭连接</span></span><br><span class="line">		connection.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>此时我们先测试运行发送者代码，然后通过管理界面可以看到我们的交换机创建成功了，如下图：</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553597112137.png" alt="1553597112137"></p><p>但是此时并没有看到队列，如下图：</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553597119600.png" alt="1553597119600"></p><p>发现此时我们的消息丢失了，因为交换机没有存储的能力，在RabbitMQ里面只有队列有存储能力，由于这时候还没有队列绑定到这个交换机，所以数据丢失了。</p><h2 id="2、创建消息消费者1：Recv-1-java-2"><a href="#2、创建消息消费者1：Recv-1-java-2" class="headerlink" title="2、创建消息消费者1：Recv_1.java"></a>2、创建消息消费者1：Recv_1.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DefaultConsumer;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Envelope;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.AMQP.BasicProperties;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv_1</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义队列名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String	QUEUE_NAME		= <span class="string">"ps_queue_email"</span>;</span><br><span class="line">	<span class="comment">//定义交换机名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String	EXCHANGE_NAME	= <span class="string">"fanout_exchange"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		<span class="comment">//1、获取连接</span></span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		<span class="comment">//2、声明信道</span></span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//3、声明队列</span></span><br><span class="line">		channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">		<span class="comment">//4、将队列绑定到交换机</span></span><br><span class="line">		channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, <span class="string">""</span>);</span><br><span class="line">		System.out.println(<span class="string">" [*] Waiting for messages. To exit press CTRL+C"</span>);</span><br><span class="line">		<span class="comment">//5、定义队列的消费者</span></span><br><span class="line">		DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">				<span class="comment">//6、获取消息</span></span><br><span class="line">				System.out.println(<span class="keyword">new</span> String(body, <span class="string">"utf-8"</span>) + <span class="string">" - 开始发送email通知"</span>);</span><br><span class="line">				channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="comment">//7、监听队列-关闭自动确认</span></span><br><span class="line">		channel.basicConsume(QUEUE_NAME, <span class="keyword">false</span>, consumer);</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3、创建消息消费者2：Recv-2-java-2"><a href="#3、创建消息消费者2：Recv-2-java-2" class="headerlink" title="3、创建消息消费者2：Recv_2.java"></a>3、创建消息消费者2：Recv_2.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DefaultConsumer;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Envelope;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.AMQP.BasicProperties;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv_2</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义队列名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String	QUEUE_NAME		= <span class="string">"ps_queue_sms"</span>;</span><br><span class="line">	<span class="comment">//定义交换机名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String	EXCHANGE_NAME	= <span class="string">"fanout_exchange"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		<span class="comment">//1、获取连接</span></span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		<span class="comment">//2、声明信道</span></span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//3、声明队列</span></span><br><span class="line">		channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">		<span class="comment">//4、将队列绑定到交换机</span></span><br><span class="line">		channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, <span class="string">""</span>);</span><br><span class="line">		System.out.println(<span class="string">" [*] Waiting for messages. To exit press CTRL+C"</span>);</span><br><span class="line">		<span class="comment">//5、定义队列的消费者</span></span><br><span class="line">		DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">				<span class="comment">//6、获取消息</span></span><br><span class="line">				System.out.println(<span class="keyword">new</span> String(body, <span class="string">"utf-8"</span>) + <span class="string">" - 开始发送短信通知"</span>);</span><br><span class="line">				channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="comment">//7、监听队列-关闭自动确认</span></span><br><span class="line">		channel.basicConsume(QUEUE_NAME, <span class="keyword">false</span>, consumer);</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4、测试结果-1"><a href="#4、测试结果-1" class="headerlink" title="4、测试结果"></a>4、测试结果</h2><p><strong>生产者</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[x] Sent &apos;注册成功&apos;</span><br></pre></td></tr></table></figure><p><strong>消费者1</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[*] Waiting for messages. To exit press CTRL+C</span><br><span class="line">注册成功 - 开始发送email通知</span><br></pre></td></tr></table></figure><p><strong>消费者2</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[*] Waiting for messages. To exit press CTRL+C</span><br><span class="line">注册成功 - 开始发送短信通知</span><br></pre></td></tr></table></figure><p><strong>管理页面</strong></p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553597186725.png" alt="1553597186725"></p><h2 id="5、应用场景-1"><a href="#5、应用场景-1" class="headerlink" title="5、应用场景"></a>5、应用场景</h2><p>比如一个商城系统需要在管理员上传商品新的图片时，前台系统必须更新图片，日志系统必须记录相应的日志，那么就可以将两个队列绑定到图片上传交换器上，一个用于前台系统更新图片，另一个用于日志系统记录日志。</p><h1 id="八、RabbitMQ-–-Routing（路由模式）"><a href="#八、RabbitMQ-–-Routing（路由模式）" class="headerlink" title="八、RabbitMQ – Routing（路由模式）"></a>八、RabbitMQ – Routing（路由模式）</h1><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553597202538.png" alt="1553597202538"></p><p>生产者将消息发送到direct交换器，在绑定队列和交换器的时候有一个路由key，生产者发送的消息会指定一个路由key，那么消息只会发送到相应key相同的队列，接着监听该队列的消费者消费消息。</p><p><strong>也就是让消费者有选择性的接收消息。</strong></p><h2 id="1、创建消息发送者：Send-java-3"><a href="#1、创建消息发送者：Send-java-3" class="headerlink" title="1、创建消息发送者：Send.java"></a>1、创建消息发送者：Send.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义交换机名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME = <span class="string">"direct_exchange"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		<span class="comment">//1、获取连接</span></span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		<span class="comment">//2、声明信道</span></span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//3、声明交换机</span></span><br><span class="line">		channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">"direct"</span>);</span><br><span class="line">		<span class="comment">//4、定义消息内容</span></span><br><span class="line">		String message = <span class="string">"橙色"</span>;</span><br><span class="line">		<span class="comment">//5、发布消息</span></span><br><span class="line">		String routingKey = <span class="string">"oranger"</span>;</span><br><span class="line">		channel.basicPublish(EXCHANGE_NAME, routingKey, <span class="keyword">null</span>, message.getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">		System.out.println(<span class="string">" [x] Sent '"</span> + message + <span class="string">"'"</span>);</span><br><span class="line">		<span class="comment">//6、关闭信道</span></span><br><span class="line">		channel.close();</span><br><span class="line">		<span class="comment">//7、关闭连接</span></span><br><span class="line">		connection.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2、创建消息消费者1：Recv-1-java-3"><a href="#2、创建消息消费者1：Recv-1-java-3" class="headerlink" title="2、创建消息消费者1：Recv_1.java"></a>2、创建消息消费者1：Recv_1.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DefaultConsumer;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Envelope;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.AMQP.BasicProperties;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv_1</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义队列名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String	QUEUE_NAME		= <span class="string">"routing_queue"</span>;</span><br><span class="line">	<span class="comment">//定义交换机名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String	EXCHANGE_NAME	= <span class="string">"direct_exchange"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		<span class="comment">//1、获取连接</span></span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		<span class="comment">//2、声明信道</span></span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//3、声明队列</span></span><br><span class="line">		channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">		<span class="comment">//4、将队列绑定到交换机</span></span><br><span class="line">		channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, <span class="string">"oranger"</span>);</span><br><span class="line">		channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, <span class="string">"green"</span>);</span><br><span class="line">		System.out.println(<span class="string">" [*] Waiting for messages. To exit press CTRL+C"</span>);</span><br><span class="line">		<span class="comment">//5、定义队列的消费者</span></span><br><span class="line">		DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">				<span class="comment">//6、获取消息</span></span><br><span class="line">				System.out.println(<span class="string">" [Recv_1] - "</span> + <span class="keyword">new</span> String(body, <span class="string">"utf-8"</span>));</span><br><span class="line">				channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="comment">//7、监听队列-关闭自动确认</span></span><br><span class="line">		channel.basicConsume(QUEUE_NAME, <span class="keyword">false</span>, consumer);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3、创建消息消费者2：Recv-2-java-3"><a href="#3、创建消息消费者2：Recv-2-java-3" class="headerlink" title="3、创建消息消费者2：Recv_2.java"></a>3、创建消息消费者2：Recv_2.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DefaultConsumer;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Envelope;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.AMQP.BasicProperties;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv_2</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义队列名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String	QUEUE_NAME		= <span class="string">"routing_queue"</span>;</span><br><span class="line">	<span class="comment">//定义交换机名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String	EXCHANGE_NAME	= <span class="string">"direct_exchange"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		<span class="comment">//1、获取连接</span></span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		<span class="comment">//2、声明信道</span></span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//3、声明队列</span></span><br><span class="line">		channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">		<span class="comment">//4、将队列绑定到交换机</span></span><br><span class="line">		channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, <span class="string">"black"</span>);</span><br><span class="line">		System.out.println(<span class="string">" [*] Waiting for messages. To exit press CTRL+C"</span>);</span><br><span class="line">		<span class="comment">//5、定义队列的消费者</span></span><br><span class="line">		DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">				<span class="comment">//6、获取消息</span></span><br><span class="line">				System.out.println(<span class="string">" [Recv_1] - "</span> + <span class="keyword">new</span> String(body, <span class="string">"utf-8"</span>));</span><br><span class="line">				channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="comment">//7、监听队列-关闭自动确认</span></span><br><span class="line">		channel.basicConsume(QUEUE_NAME, <span class="keyword">false</span>, consumer);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4、测试结果-2"><a href="#4、测试结果-2" class="headerlink" title="4、测试结果"></a>4、测试结果</h2><p>我们首先看代码，生产者发布消息，指定的路由key为<strong>oranger</strong>。消费者1绑定队列和交换机时key分别是<strong>oranger/green</strong>；消费者2绑定队列和交换器时key是<strong>black</strong>。</p><p>所以我们可以猜测生产者发送的消息，只有消费者1能够接收并消费，而消费者2是不能接收的。</p><p><strong>生产者</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[x] Sent &apos;橙色&apos;</span><br></pre></td></tr></table></figure><p><strong>消费者1</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[*] Waiting for messages. To exit press CTRL+C</span><br><span class="line">[Recv_1] - 橙色</span><br></pre></td></tr></table></figure><p><strong>消费者2</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[*] Waiting for messages. To exit press CTRL+C</span><br></pre></td></tr></table></figure><h2 id="5、应用场景-2"><a href="#5、应用场景-2" class="headerlink" title="5、应用场景"></a>5、应用场景</h2><p>利用消费者能够有选择性的接收消息的特性，比如我们商城系统的后台管理系统对于商品进行修改、删除、新增操作都需要更新前台系统的界面展示，而查询操作确不需要，那么这两个队列分开接收消息就比较好。</p><h1 id="九、RabbitMQ-–-Topics（主题模式）"><a href="#九、RabbitMQ-–-Topics（主题模式）" class="headerlink" title="九、RabbitMQ – Topics（主题模式）"></a>九、RabbitMQ – Topics（主题模式）</h1><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553597305637.png" alt="1553597305637"></p><p>生产者将消息发送到topic交换器。</p><p>上面的路由模式是根据路由key进行完整的匹配（完全相等才发送消息），这里的通配符模式通俗的来讲就是模糊匹配。</p><p><strong>符号“#”表示匹配一个或多个词，符号“*”表示匹配一个词。</strong></p><h2 id="1、创建消息发送者：Send-java-4"><a href="#1、创建消息发送者：Send-java-4" class="headerlink" title="1、创建消息发送者：Send.java"></a>1、创建消息发送者：Send.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义交换机名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME = <span class="string">"topic_exchange"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		<span class="comment">//1、获取连接</span></span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		<span class="comment">//2、声明信道</span></span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//3、声明交换机</span></span><br><span class="line">		channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">"topic"</span>);</span><br><span class="line">		<span class="comment">//4、定义消息内容</span></span><br><span class="line">		String messageByAdd = <span class="string">"新增用户"</span>;</span><br><span class="line">		<span class="comment">//5、发布消息</span></span><br><span class="line">		String routingKeyByAdd = <span class="string">"user.add"</span>;</span><br><span class="line">		channel.basicPublish(EXCHANGE_NAME, routingKeyByAdd, <span class="keyword">null</span>, messageByAdd.getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">		System.out.println(<span class="string">" [x] Sent '"</span> + messageByAdd + <span class="string">"'"</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//4、定义消息内容</span></span><br><span class="line">		String messageByDel = <span class="string">"新增用户"</span>;</span><br><span class="line">		<span class="comment">//5、发布消息</span></span><br><span class="line">		String routingKeyByDel = <span class="string">"user.delete"</span>;</span><br><span class="line">		channel.basicPublish(EXCHANGE_NAME, routingKeyByDel, <span class="keyword">null</span>, messageByDel.getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">		System.out.println(<span class="string">" [x] Sent '"</span> + messageByDel + <span class="string">"'"</span>);</span><br><span class="line">		<span class="comment">//6、关闭信道</span></span><br><span class="line">		channel.close();</span><br><span class="line">		<span class="comment">//7、关闭连接</span></span><br><span class="line">		connection.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2、创建消息消费者1：Recv-1-java-4"><a href="#2、创建消息消费者1：Recv-1-java-4" class="headerlink" title="2、创建消息消费者1：Recv_1.java"></a>2、创建消息消费者1：Recv_1.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DefaultConsumer;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Envelope;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.AMQP.BasicProperties;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv_1</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义队列名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String	QUEUE_NAME		= <span class="string">"topic_queue_1"</span>;</span><br><span class="line">	<span class="comment">//定义交换机名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String	EXCHANGE_NAME	= <span class="string">"topic_exchange"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		<span class="comment">//1、获取连接</span></span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		<span class="comment">//2、声明信道</span></span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//3、声明队列</span></span><br><span class="line">		channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">		<span class="comment">//4、将队列绑定到交换机</span></span><br><span class="line">		channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, <span class="string">"user.add"</span>);</span><br><span class="line">		System.out.println(<span class="string">" [*] Waiting for messages. To exit press CTRL+C"</span>);</span><br><span class="line">		<span class="comment">//5、定义队列的消费者</span></span><br><span class="line">		DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">				<span class="comment">//6、获取消息</span></span><br><span class="line">				System.out.println(<span class="string">" [Recv_1] - "</span> + <span class="keyword">new</span> String(body, <span class="string">"utf-8"</span>));</span><br><span class="line">				channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="comment">//7、监听队列-关闭自动确认</span></span><br><span class="line">		channel.basicConsume(QUEUE_NAME, <span class="keyword">false</span>, consumer);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3、创建消息消费者2：Recv-2-java-4"><a href="#3、创建消息消费者2：Recv-2-java-4" class="headerlink" title="3、创建消息消费者2：Recv_2.java"></a>3、创建消息消费者2：Recv_2.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DefaultConsumer;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Envelope;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.AMQP.BasicProperties;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv_2</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义队列名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String	QUEUE_NAME		= <span class="string">"topic_queue_2"</span>;</span><br><span class="line">	<span class="comment">//定义交换机名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String	EXCHANGE_NAME	= <span class="string">"topic_exchange"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		<span class="comment">//1、获取连接</span></span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		<span class="comment">//2、声明信道</span></span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//3、声明队列</span></span><br><span class="line">		channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">		<span class="comment">//4、将队列绑定到交换机</span></span><br><span class="line">		channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, <span class="string">"user.#"</span>);</span><br><span class="line">		System.out.println(<span class="string">" [*] Waiting for messages. To exit press CTRL+C"</span>);</span><br><span class="line">		<span class="comment">//5、定义队列的消费者</span></span><br><span class="line">		DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">				<span class="comment">//6、获取消息</span></span><br><span class="line">				System.out.println(<span class="string">" [Recv_1] - "</span> + <span class="keyword">new</span> String(body, <span class="string">"utf-8"</span>));</span><br><span class="line">				channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="comment">//7、监听队列-关闭自动确认</span></span><br><span class="line">		channel.basicConsume(QUEUE_NAME, <span class="keyword">false</span>, consumer);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4、测试结果-3"><a href="#4、测试结果-3" class="headerlink" title="4、测试结果"></a>4、测试结果</h2><p>生产者发布消息绑定的路由key为<strong>user.add</strong>和<strong>user.delete</strong>。消费者1绑定队列和交换机绑定路由key为<strong>user.add</strong>；消费者2绑定队列和交换机绑定路由key为<strong>user.#</strong>。</p><p>所以我们可以猜测生产者发送的消息，消费者1能够接收并消费新增用户的消息，而消费者2能接收新增和删除用户的消息。</p><p><strong>生产者</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[x] Sent &apos;新增用户&apos;</span><br><span class="line">[x] Sent &apos;删除用户&apos;</span><br></pre></td></tr></table></figure><p><strong>消费者1</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Recv_1] - 新增用户</span><br></pre></td></tr></table></figure><p><strong>消费者2</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[Recv_1] - 新增用户</span><br><span class="line">[Recv_1] - 删除用户</span><br></pre></td></tr></table></figure><h1 id="十、RabbitMQ-消息应答ack机制"><a href="#十、RabbitMQ-消息应答ack机制" class="headerlink" title="十、RabbitMQ - 消息应答ack机制"></a>十、RabbitMQ - 消息应答ack机制</h1><h2 id="1、创建消息发送者：Send-java-5"><a href="#1、创建消息发送者：Send-java-5" class="headerlink" title="1、创建消息发送者：Send.java"></a>1、创建消息发送者：Send.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME = <span class="string">"simple_exchange"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">"fanout"</span>, <span class="keyword">false</span>);</span><br><span class="line">		String message = <span class="string">"ack_test"</span>;</span><br><span class="line">		channel.basicPublish(EXCHANGE_NAME, <span class="string">""</span>, <span class="keyword">null</span>, message.getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">		System.out.println(<span class="string">" [x] Sent '"</span> + message + <span class="string">"'"</span>);</span><br><span class="line">		channel.close();</span><br><span class="line">		connection.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="2、自动应答-创建消息消费者：RecvAutoAck-java"><a href="#2、自动应答-创建消息消费者：RecvAutoAck-java" class="headerlink" title="2、自动应答-创建消息消费者：RecvAutoAck.java"></a>2、自动应答-创建消息消费者：RecvAutoAck.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DefaultConsumer;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Envelope;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.AMQP.BasicProperties;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RecvAutoAck</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String	QUEUE_NAME		= <span class="string">"simple_queue"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String	EXCHANGE_NAME	= <span class="string">"simple_exchange"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">		channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, <span class="string">""</span>);</span><br><span class="line">		System.out.println(<span class="string">" [*] Waiting for messages. To exit press CTRL+C"</span>);</span><br><span class="line">		DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">" [Recv_1] - "</span> + <span class="keyword">new</span> String(body, <span class="string">"utf-8"</span>));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="comment">//开启自动应答机制</span></span><br><span class="line">		<span class="keyword">boolean</span> autoAck = <span class="keyword">true</span>;</span><br><span class="line">		channel.basicConsume(QUEUE_NAME, autoAck, consumer);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="3、手动应答-创建消息消费者：RecvBasicAck-java"><a href="#3、手动应答-创建消息消费者：RecvBasicAck-java" class="headerlink" title="3、手动应答-创建消息消费者：RecvBasicAck.java"></a>3、手动应答-创建消息消费者：RecvBasicAck.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DefaultConsumer;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Envelope;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.AMQP.BasicProperties;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RecvBasciAck</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String	QUEUE_NAME		= <span class="string">"simple_queue"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String	EXCHANGE_NAME	= <span class="string">"simple_exchange"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">		channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, <span class="string">""</span>);</span><br><span class="line">		System.out.println(<span class="string">" [*] Waiting for messages. To exit press CTRL+C"</span>);</span><br><span class="line">		DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">" [Recv_1] - "</span> + <span class="keyword">new</span> String(body, <span class="string">"utf-8"</span>));</span><br><span class="line">				<span class="comment">//手动应答</span></span><br><span class="line">				channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="comment">//关闭自动应答机制</span></span><br><span class="line">		<span class="keyword">boolean</span> autoAck = <span class="keyword">false</span>;</span><br><span class="line">		channel.basicConsume(QUEUE_NAME, autoAck, consumer);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="方法1：basicAck（确认收到一个或多个消息）"><a href="#方法1：basicAck（确认收到一个或多个消息）" class="headerlink" title="方法1：basicAck（确认收到一个或多个消息）"></a>方法1：basicAck（确认收到一个或多个消息）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//deliveryTag：该消息的index</span></span><br><span class="line"><span class="comment">//multiple：是否批量.true：将一次性ack所有小于deliveryTag的消息</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">basicAck</span><span class="params">(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> multiple)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure><h3 id="方法2：basicReject（拒绝一条收到的消息-单条拒绝）"><a href="#方法2：basicReject（拒绝一条收到的消息-单条拒绝）" class="headerlink" title="方法2：basicReject（拒绝一条收到的消息-单条拒绝）"></a>方法2：basicReject（拒绝一条收到的消息-单条拒绝）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//deliveryTag:该消息的index</span></span><br><span class="line"><span class="comment">//requeue：被拒绝的是否重新入队列</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">basicReject</span><span class="params">(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> requeue)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure><h3 id="方法3：basicNack（拒绝一条或多条收到的消息-批量拒绝）"><a href="#方法3：basicNack（拒绝一条或多条收到的消息-批量拒绝）" class="headerlink" title="方法3：basicNack（拒绝一条或多条收到的消息-批量拒绝）"></a>方法3：basicNack（拒绝一条或多条收到的消息-批量拒绝）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//deliveryTag:该消息的index</span></span><br><span class="line"><span class="comment">//multiple：是否批量.true:将一次性拒绝所有小于deliveryTag的消息。</span></span><br><span class="line"><span class="comment">//requeue：被拒绝的是否重新入队列</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">basicNack</span><span class="params">(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> multiple, <span class="keyword">boolean</span> requeue)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure><h3 id="方法4：basicRecover（重新发送到队列中）"><a href="#方法4：basicRecover（重新发送到队列中）" class="headerlink" title="方法4：basicRecover（重新发送到队列中）"></a>方法4：basicRecover（重新发送到队列中）</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//requeue：被拒绝的是否重新入队列</span></span><br><span class="line">Basic.<span class="function">RecoverOk <span class="title">basicRecover</span><span class="params">(<span class="keyword">boolean</span> requeue)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure><h2 id="4、注意"><a href="#4、注意" class="headerlink" title="4、注意"></a>4、注意</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Caused by: com.rabbitmq.client.ShutdownSignalException: channel error; protocol method: #method&lt;channel.close&gt;(reply-code=406, reply-text=PRECONDITION_FAILED - inequivalent arg &apos;durable&apos; for queue &apos;simple_queue&apos; in vhost &apos;/virtual_test&apos;: received &apos;false&apos; but current is &apos;true&apos;, class-id=50, method-id=10)</span><br><span class="line">	at com.rabbitmq.client.impl.ChannelN.asyncShutdown(ChannelN.java:516)</span><br><span class="line">	at com.rabbitmq.client.impl.ChannelN.processAsync(ChannelN.java:346)</span><br><span class="line">	at com.rabbitmq.client.impl.AMQChannel.handleCompleteInboundCommand(AMQChannel.java:182)</span><br><span class="line">	at com.rabbitmq.client.impl.AMQChannel.handleFrame(AMQChannel.java:114)</span><br><span class="line">	at com.rabbitmq.client.impl.AMQConnection.readFrame(AMQConnection.java:672)</span><br><span class="line">	at com.rabbitmq.client.impl.AMQConnection.access$300(AMQConnection.java:48)</span><br><span class="line">	at com.rabbitmq.client.impl.AMQConnection$MainLoop.run(AMQConnection.java:599)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:748)</span><br></pre></td></tr></table></figure><p>以上异常是由于修改了队列的应答模式，需要删除之前的队列，或者重新定义新的队列，因为队列和交换机的一些属性一旦定义，就不允许修改。</p><h1 id="十一、RabbitMQ-消息的持久性"><a href="#十一、RabbitMQ-消息的持久性" class="headerlink" title="十一、RabbitMQ - 消息的持久性"></a>十一、RabbitMQ - 消息的持久性</h1><p>在正常的服务器运行过程中，时常会面临服务器宕机重启的情况，那么我们的消息此时会如何呢？很不幸的事情就是，我们的消息可能会消失，这肯定不是我们希望见到的结果。所以我们希望AMQP服务器崩溃了也可以将消息恢复，这称之为消息持久化。RabbitMQ自然存在这种策略可以帮助我们完成这件事情。</p><p>如果我们希望即使在RabbitMQ服务重启的情况下，也不会丢失消息，我们可以将Queue、Exchange与Message都设置为可持久化的（durable），这样可以保证绝大部分情况下我们的RabbitMQ消息不会丢失。当然还是会有一些小概率事件会导致消息丢失。</p><h2 id="1、交换机持久化"><a href="#1、交换机持久化" class="headerlink" title="1、交换机持久化"></a>1、交换机持久化</h2><h3 id="创建消息发送者代码：Send-java"><a href="#创建消息发送者代码：Send-java" class="headerlink" title="创建消息发送者代码：Send.java"></a>创建消息发送者代码：Send.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME = <span class="string">"simple_exchange"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//声明交换机-并开启交换机的持久化策略</span></span><br><span class="line">		<span class="keyword">boolean</span> durable = <span class="keyword">true</span>;</span><br><span class="line">		channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">"fanout"</span>, durable);</span><br><span class="line">		String message = <span class="string">"exchange_durable_test"</span>;</span><br><span class="line">		channel.basicPublish(EXCHANGE_NAME, <span class="string">""</span>, <span class="keyword">null</span>, message.getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">		System.out.println(<span class="string">" [x] Sent '"</span> + message + <span class="string">"'"</span>);</span><br><span class="line">		channel.close();</span><br><span class="line">		connection.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>关闭交换机持久化策略：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> durable = <span class="keyword">false</span>;</span><br><span class="line">channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">""</span>, durable);</span><br></pre></td></tr></table></figure><p><strong>开启交换机持久化策略：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> durable = <span class="keyword">true</span>;</span><br><span class="line">channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">""</span>, durable);</span><br></pre></td></tr></table></figure><h3 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h3><p>设置durable = <strong>false</strong>时;运行<strong>Send.java</strong>，进入控制台我们可以看到我们刚刚创建交换机，然后执行rabbitmq-service stop命令停止RabbitMQ服务，再执行 rabbitmq-service start命令启动RabbitMQ服务，进入控制台我们可以发现刚刚我们创建的交换机消失了。</p><p>设置durable = <strong>true</strong>;重复上述步骤，我们可以发现我们的交换机持久化策略已经生效。</p><h2 id="2、队列持久化"><a href="#2、队列持久化" class="headerlink" title="2、队列持久化"></a>2、队列持久化</h2><h3 id="创建消息发送者代码：Send-java（引用上一步的代码）"><a href="#创建消息发送者代码：Send-java（引用上一步的代码）" class="headerlink" title="创建消息发送者代码：Send.java（引用上一步的代码）"></a>创建消息发送者代码：Send.java（引用上一步的代码）</h3><h3 id="创建消息消费者代码：Recv-java"><a href="#创建消息消费者代码：Recv-java" class="headerlink" title="创建消息消费者代码：Recv.java"></a>创建消息消费者代码：Recv.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.DefaultConsumer;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Envelope;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.AMQP.BasicProperties;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Recv</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String	QUEUE_NAME		= <span class="string">"simple_queue"</span>;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String	EXCHANGE_NAME	= <span class="string">"simple_exchange"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//声明队列-并开启队列的持久化策略</span></span><br><span class="line">		<span class="keyword">boolean</span> durable = <span class="keyword">false</span>;</span><br><span class="line">		channel.queueDeclare(QUEUE_NAME, durable, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">		channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, <span class="string">""</span>);</span><br><span class="line">		System.out.println(<span class="string">" [*] Waiting for messages. To exit press CTRL+C"</span>);</span><br><span class="line">		DefaultConsumer consumer = <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, BasicProperties properties, <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">" [Recv_1] - "</span> + <span class="keyword">new</span> String(body, <span class="string">"utf-8"</span>));</span><br><span class="line">				channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">		channel.basicConsume(QUEUE_NAME, <span class="keyword">false</span>, consumer);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>关闭队列持久化策略：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> durable = <span class="keyword">false</span>;</span><br><span class="line">channel.queueDeclare(QUEUE_NAME, durable, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure><p><strong>开启队列持久化策略：</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> durable = <span class="keyword">true</span>;</span><br><span class="line">channel.queueDeclare(QUEUE_NAME, durable, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br></pre></td></tr></table></figure><h3 id="测试结果-1"><a href="#测试结果-1" class="headerlink" title="测试结果"></a>测试结果</h3><p>设置durable = <strong>false</strong>时;运行<strong>Recv.java</strong>，进入控制台我们可以看到我们刚刚创建交换机，然后执行rabbitmq-service stop命令停止RabbitMQ服务，再执行 rabbitmq-service start命令启动RabbitMQ服务，进入控制台发现刚刚创建的队列依然存在，这是为什么呢，已经关闭了持久化策略，原因是我们的消费端还一直处于监听队列的状态，再我们重启RabbitMQ之后立马又帮我们声明了这个队列，那如果消费端也宕机了，我们这里先关闭消费端的监听，再重启查看，发现果然如预想的一样，队列已经不存在了。</p><p>设置durable = <strong>true</strong>;重复上述步骤，发现我们的队列依然存在，队列持久化策略已经生效。</p><p>简单队列和Work Queue由于没有使用到交换机，所以队列的声明是在发送者端完成的；Publish/Subscribe、Routing、Topics由于用到了交换机，所以队列的声明在消费者端，消费者端再将各自的队列绑定到交换机；这两种情况都不影响队列的持久化，它们的持久化策略和方式都是一样的。</p><h2 id="3、消息持久化"><a href="#3、消息持久化" class="headerlink" title="3、消息持久化"></a>3、消息持久化</h2><h3 id="修改消息发送者代码：Send-java"><a href="#修改消息发送者代码：Send-java" class="headerlink" title="修改消息发送者代码：Send.java"></a>修改消息发送者代码：Send.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.AMQP;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//定义交换机名称</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE_NAME = <span class="string">"simple_exchange"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		<span class="comment">//声明交换机-并开启交换机的持久化策略</span></span><br><span class="line">		<span class="keyword">boolean</span> durable = <span class="keyword">true</span>;</span><br><span class="line">		channel.exchangeDeclare(EXCHANGE_NAME, <span class="string">"fanout"</span>, durable);</span><br><span class="line">		String message = <span class="string">"durable_test"</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//传送模式-标记持久化</span></span><br><span class="line">		<span class="keyword">int</span> deliveryMode = <span class="number">2</span>;</span><br><span class="line">		AMQP.BasicProperties basicProperties = <span class="keyword">new</span> AMQP.BasicProperties().builder().deliveryMode(deliveryMode).build();</span><br><span class="line">		channel.basicPublish(EXCHANGE_NAME, <span class="string">""</span>, basicProperties, message.getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">		System.out.println(<span class="string">" [x] Sent '"</span> + message + <span class="string">"'"</span>);</span><br><span class="line">		channel.close();</span><br><span class="line">		connection.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AMQP.BasicProperties 提供了一个构造器，可以通过builder() 来设置一些属性；可以通过AMQP.BasicProperties 来设置消息的一些属性，更多属性设置参见<a href="https://rabbitmq.github.io/rabbitmq-java-client/api/current/" target="_blank" rel="noopener"><strong>官方API文档</strong></a>。</p><p>运行上一个例子的Send.java时，重启RabbitMQ服务后发现我们发布的消息消失了，运行本例，重启RabbitMQ服务后消息依然存在，可以证明我们的消息持久化策略也已经生效。</p><p>将消息以持久化方式发布时，会对性能造成一定的影响（就像数据库操作一样，健壮性的存在必定造成一些性能牺牲）。</p><h2 id="4、小结"><a href="#4、小结" class="headerlink" title="4、小结"></a>4、小结</h2><p>当RabbitMQ服务器重启后，原先的队列和交换器会随同里面的消息一同消失。原因在于每个队列和交换器都有durable属性，该属性默认是false，它决定了RabbitMQ是否需要在崩溃或者重启之后重新创建队列或者交换器。将它设置为true就代表了持久性，在服务器重启之后就会重新持久的创建队列和交换器。</p><p>当然做到这点还不够，我们需要的是持久化的消息，所以在消息发布前，通过将消息的“投递模式”(delivery mode)属性设置为2将消息标记为持久化。到目前为止，消息还只是被表示为持久化，还需要被发布到持久化的交换器中并到达持久化的队列中才行。如果不是这样，包含持久化消息的队列或者交换器挥着Rabbit崩溃重启后不复存在，导致消息成为一个孤儿。因此，总结起来需要做到以下三点：</p><ol><li>将消息的投递模式选项设置为2(持久)；</li><li>将消息发送到持久化的交换器；</li><li>消息到达持久化的队列。</li></ol><p><strong>注意，如果原先有非持久的交换器或者队列，需要删除后才可重新创建，否则就创建其他名称的交换器或者队列。</strong></p><h1 id="十二、RabbitMQ-–消息确认机制"><a href="#十二、RabbitMQ-–消息确认机制" class="headerlink" title="十二、RabbitMQ –消息确认机制"></a>十二、RabbitMQ –消息确认机制</h1><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553597763131.png" alt="1553597763131"></p><p>正常情况下，如果消息经过交换器进入队列就可以完成消息的持久化，但如果消息在没有到达RabbitMQ服务器Broker之前出现意外，那就造成消息丢失，有没有办法可以解决这个问题？</p><p>RabbitMQ有两种方式来解决这个问题：</p><p>通过AMQP提供的事务机制实现；</p><p>使用发送者确认模式实现；</p><h2 id="1、事务机制"><a href="#1、事务机制" class="headerlink" title="1、事务机制"></a>1、事务机制</h2><p>事务的实现主要是对信道（Channel）的设置，主要的方法有三个：</p><ol><li><p>channel.txSelect() 声明启动事务模式；</p></li><li><p>channel.txComment() 提交事务；</p></li><li><p>channel.txRollback() 回滚事务；</p></li></ol><h3 id="发送者使用事务"><a href="#发送者使用事务" class="headerlink" title="发送者使用事务"></a>发送者使用事务</h3><h4 id="创建消息发送者代码：Send-java-1"><a href="#创建消息发送者代码：Send-java-1" class="headerlink" title="创建消息发送者代码：Send.java"></a>创建消息发送者代码：Send.java</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Send</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"transaction_queue"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException </span>&#123;</span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">		String message = <span class="string">"transaction_test"</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="comment">//1、声明事务</span></span><br><span class="line">			channel.txSelect();</span><br><span class="line">			channel.basicPublish(<span class="string">""</span>, QUEUE_NAME, <span class="keyword">null</span>, message.getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">			System.out.println(<span class="string">" [x] Sent '"</span> + message + <span class="string">"'"</span>);</span><br><span class="line">			<span class="comment">//除以0，模拟异常，使用rabbitmq默认交换机</span></span><br><span class="line">			<span class="keyword">int</span> i = <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">			<span class="comment">//2、提交事务</span></span><br><span class="line">			channel.txCommit();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="comment">//3、回滚事务</span></span><br><span class="line">			channel.txRollback();</span><br><span class="line">			System.out.println(<span class="string">"回滚事务："</span> + e.getMessage());</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			channel.close();</span><br><span class="line">			connection.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>从上面的代码我们可以看出，在发送消息之前的代码和之前介绍的都是一样的，只是在发送消息之前，需要声明channel为事务模式，提交或者回滚事务即可。</p><h3 id="消费者使用事务"><a href="#消费者使用事务" class="headerlink" title="消费者使用事务"></a>消费者使用事务</h3><p>假设消费者模式中使用了事务，并且在消息确认之后进行了事务回滚，那么RabbitMQ会产生什么样的变化？</p><p>结果分为两种情况：</p><ul><li><p>autoAck=false手动应对的时候是支持事务的，也就是说即使你已经手动确认了消息已经收到了，但在确认消息会等事务的返回解决之后，在做决定是确认消息还是重新放回队列，如果你手动确认现在之后，又回滚了事务，那么已事务回滚为主，此条消息会重新放回队列；</p></li><li><p>autoAck=true如果自定确认为true的情况是不支持事务的，也就是说你即使在收到消息之后在回滚事务也是于事无补的，队列已经把消息移除了；</p></li></ul><h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>事务模式的性能很差，那有没有既能保证消息的可靠性又能兼顾性能的解决方案呢？那就是接下来要讲的Confirm发送方确认模式。</p><h2 id="2、Confirm发送方确认模式"><a href="#2、Confirm发送方确认模式" class="headerlink" title="2、Confirm发送方确认模式"></a>2、Confirm发送方确认模式</h2><p>Confirm发送方确认模式使用和事务类似，也是通过设置Channel进行发送方确认的。</p><p>Confirm的三种实现方式：</p><ol><li><p>channel.waitForConfirms() 普通发送方确认模式；</p></li><li><p>channel.waitForConfirmsOrDie() 批量确认模式；</p></li><li><p>channel.addConfirmListener() 异步监听发送方确认模式；</p></li></ol><h3 id="方式一：普通Confirm模式：SendConfirm-java"><a href="#方式一：普通Confirm模式：SendConfirm-java" class="headerlink" title="方式一：普通Confirm模式：SendConfirm.java"></a>方式一：普通Confirm模式：SendConfirm.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendConfirm</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"confirm_queue"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException, InterruptedException </span>&#123;</span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">		String message = <span class="string">" confirm_test"</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//开启发送方确认模式</span></span><br><span class="line">		channel.confirmSelect();</span><br><span class="line">		channel.basicPublish(<span class="string">""</span>, QUEUE_NAME, <span class="keyword">null</span>, message.getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">		System.out.println(<span class="string">" [x] Sent '"</span> + message + <span class="string">"'"</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (channel.waitForConfirms()) &#123;</span><br><span class="line">			System.out.println(<span class="string">"消息发送成功"</span> );</span><br><span class="line">		&#125;</span><br><span class="line">		channel.close();</span><br><span class="line">		connection.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看代码可以知道，我们只需要在推送消息之前，channel.confirmSelect()声明开启发送方确认模式，再使用channel.waitForConfirms()等待消息被服务器确认即可。</p><h3 id="方式二：批量Confirm模式：SendBatchConfirm-java"><a href="#方式二：批量Confirm模式：SendBatchConfirm-java" class="headerlink" title="方式二：批量Confirm模式：SendBatchConfirm.java"></a>方式二：批量Confirm模式：SendBatchConfirm.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendBatchConfirm</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"confirm_queue"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException, InterruptedException </span>&#123;</span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">		String message = <span class="string">" confirm_test"</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//开启发送方确认模式</span></span><br><span class="line">		channel.confirmSelect();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">			channel.basicPublish(<span class="string">""</span>, QUEUE_NAME, <span class="keyword">null</span>, message.getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">			System.out.println(<span class="string">" [x] Sent '"</span> + message + <span class="string">"' - "</span> + i);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//直到所有信息都发布，只要有一个未确认就会IOException</span></span><br><span class="line">		channel.waitForConfirmsOrDie();</span><br><span class="line">		System.out.println(<span class="string">"消息发送成功"</span>);</span><br><span class="line">		channel.close();</span><br><span class="line">		connection.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以上代码可以看出来channel.waitForConfirmsOrDie()，使用同步方式等所有的消息发送之后才会执行后面代码，只要有一个消息未被确认就会抛出IOException异常。</p><h3 id="方式三：异步Confirm模式：SendAsynConfirm-java"><a href="#方式三：异步Confirm模式：SendAsynConfirm-java" class="headerlink" title="方式三：异步Confirm模式：SendAsynConfirm.java"></a>方式三：异步Confirm模式：SendAsynConfirm.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConfirmListener;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> cn.dj.rabbitmq.util.ConnectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SendAsynConfirm</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE_NAME = <span class="string">"confirm_queue"</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, TimeoutException, InterruptedException </span>&#123;</span><br><span class="line">		Connection connection = ConnectionUtils.getConnection();</span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		channel.queueDeclare(QUEUE_NAME, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//开启发送方确认模式</span></span><br><span class="line">		channel.confirmSelect();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//异步监听确认和未确认的消息</span></span><br><span class="line">		channel.addConfirmListener(<span class="keyword">new</span> ConfirmListener() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleNack</span><span class="params">(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> multiple)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">"未确认消息，标识："</span> + deliveryTag);</span><br><span class="line">			&#125;</span><br><span class="line">			</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleAck</span><span class="params">(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> multiple)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="comment">//这里设置秒延迟，便于观察</span></span><br><span class="line">					Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					e.printStackTrace();</span><br><span class="line">				&#125;</span><br><span class="line">				System.out.println(String.format(<span class="string">"已确认消息，标识：%d，多个消息：%b"</span>, deliveryTag, multiple));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line"></span><br><span class="line">		String message = <span class="string">"confirm_test"</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">			channel.basicPublish(<span class="string">""</span>, QUEUE_NAME, <span class="keyword">null</span>, message.getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">			System.out.println(<span class="string">" [x] Sent '"</span> + message + <span class="string">"' - "</span> + i);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		System.out.println(<span class="string">"程序执行结束"</span>);</span><br><span class="line">		</span><br><span class="line">		channel.close();</span><br><span class="line">		connection.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>异步模式的优点，就是执行效率高，不需要等待消息执行完，只需要监听消息即可，以上异步返回的信息如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> [x] Sent &apos;confirm_test&apos; - 0</span><br><span class="line"> [x] Sent &apos;confirm_test&apos; - 1</span><br><span class="line"> [x] Sent &apos;confirm_test&apos; - 2</span><br><span class="line"> [x] Sent &apos;confirm_test&apos; - 3</span><br><span class="line"> [x] Sent &apos;confirm_test&apos; - 4</span><br><span class="line">程序执行结束</span><br><span class="line">已确认消息，标识：1，多个消息：false</span><br></pre></td></tr></table></figure><h1 id="十三、RabbitMQ-–-Spring集成-XML版本"><a href="#十三、RabbitMQ-–-Spring集成-XML版本" class="headerlink" title="十三、RabbitMQ – Spring集成-XML版本"></a>十三、RabbitMQ – Spring集成-XML版本</h1><h2 id="1、新建Maven项目，修改pom-xml"><a href="#1、新建Maven项目，修改pom-xml" class="headerlink" title="1、新建Maven项目，修改pom.xml"></a>1、新建Maven项目，修改pom.xml</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cn.dj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rabbitmq-spring-xml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>rabbitmq-spring-xml<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.apache.org<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">jdk.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">jdk.version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.amqp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.12.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">finalName</span>&gt;</span>rabbitmq-spring-xml<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">source</span>&gt;</span>$&#123;jdk.version&#125;<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">target</span>&gt;</span>$&#123;jdk.version&#125;<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="2、新建spring-rabbitmq-xml配置文件"><a href="#2、新建spring-rabbitmq-xml配置文件" class="headerlink" title="2、新建spring-rabbitmq.xml配置文件"></a>2、新建spring-rabbitmq.xml配置文件</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br><span class="line"><span class="tag">		<span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span>  </span></span><br><span class="line"><span class="tag">		<span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span> </span></span><br><span class="line"><span class="tag">		<span class="attr">xmlns:rabbit</span>=<span class="string">"http://www.springframework.org/schema/rabbit"</span> </span></span><br><span class="line"><span class="tag">		<span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans </span></span></span><br><span class="line"><span class="tag"><span class="string">							http://www.springframework.org/schema/beans/spring-beans-3.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">							http://www.springframework.org/schema/context </span></span></span><br><span class="line"><span class="tag"><span class="string">							http://www.springframework.org/schema/context/spring-context-3.0.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">							http://www.springframework.org/schema/rabbit</span></span></span><br><span class="line"><span class="tag"><span class="string">							http://www.springframework.org/schema/rabbit/spring-rabbit-1.7.xsd"</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">&lt;!-- 1、配置Rabbit连接工厂 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">rabbit:connection-factory</span> <span class="attr">id</span>=<span class="string">"connectionFactory"</span> <span class="attr">host</span>=<span class="string">"127.0.0.1"</span> <span class="attr">port</span>=<span class="string">"5672"</span> <span class="attr">virtual-host</span>=<span class="string">"/virtual_test"</span> <span class="attr">username</span>=<span class="string">"djtest"</span> <span class="attr">password</span>=<span class="string">"djtest"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- 2、创建Rabbit消息队列模版 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">rabbit:template</span> <span class="attr">id</span>=<span class="string">"amqpTemplate"</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span> <span class="attr">exchange</span>=<span class="string">"fanoutExchange"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- 3、MQ的管理，包括队列、交换机等 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">rabbit:admin</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- 4、定义队列，自动声明 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">rabbit:queue</span> <span class="attr">name</span>=<span class="string">"spring_rabbit_queue"</span> <span class="attr">auto-declare</span>=<span class="string">"true"</span> <span class="attr">durable</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">&lt;!-- 5、定义交换机，自动声明 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">rabbit:fanout-exchange</span> <span class="attr">id</span>=<span class="string">"fanoutExchange"</span> <span class="attr">name</span>=<span class="string">"fanoutExchange"</span> <span class="attr">auto-declare</span>=<span class="string">"true"</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 6、绑定队列 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">rabbit:binding</span> <span class="attr">queue</span>=<span class="string">"spring_rabbit_queue"</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">rabbit:bindings</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">rabbit:fanout-exchange</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">&lt;!-- 7、队列监听 --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">rabbit:listener-container</span> <span class="attr">connection-factory</span>=<span class="string">"connectionFactory"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">rabbit:listener</span> <span class="attr">ref</span>=<span class="string">"testConsumer1"</span> <span class="attr">method</span>=<span class="string">"listen"</span> <span class="attr">queue-names</span>=<span class="string">"spring_rabbit_queue"</span> /&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- &lt;rabbit:listener ref="testConsumer2" queue-names="spring_rabbit_queue" /&gt; --&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">rabbit:listener-container</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">&lt;!-- 8、消费者 </span></span><br><span class="line"><span class="comment">		消费者1：采用指定监听方法的方式</span></span><br><span class="line"><span class="comment">		消费者2：采用实现接口的方式、无需指定方法</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"testConsumer1"</span> <span class="attr">class</span>=<span class="string">"cn.dj.rabbit.consumer.TestConsumer1"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- &lt;bean id="testConsumer2" class="cn.dj.rabbit.consumer.TestConsumer2"&gt;&lt;/bean&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="3、新建消费者"><a href="#3、新建消费者" class="headerlink" title="3、新建消费者"></a>3、新建消费者</h2><h4 id="TestConsumer1-java（指定方法方式）"><a href="#TestConsumer1-java（指定方法方式）" class="headerlink" title="TestConsumer1.java（指定方法方式）"></a>TestConsumer1.java（指定方法方式）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConsumer1</span> </span>&#123;</span><br><span class="line">	<span class="comment">//监听方法</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">listen</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"收到消息===&gt;"</span> + msg);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="TestConsumer2-java（实现接口方式）"><a href="#TestConsumer2-java（实现接口方式）" class="headerlink" title="TestConsumer2.java（实现接口方式）"></a>TestConsumer2.java（实现接口方式）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConsumer2</span> <span class="keyword">implements</span> <span class="title">MessageListener</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			System.out.println(<span class="string">"收到消息===&gt;"</span> + <span class="keyword">new</span> String(msg.getBody(), <span class="string">"utf-8"</span>));</span><br><span class="line">		&#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="4、新建启动类：SpringMain-java"><a href="#4、新建启动类：SpringMain-java" class="headerlink" title="4、新建启动类：SpringMain.java"></a>4、新建启动类：SpringMain.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.AbstractApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringMain</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">		AbstractApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"classpath:spring-rabbitmq.xml"</span>);</span><br><span class="line">		RabbitTemplate template = context.getBean(RabbitTemplate.class);</span><br><span class="line">		template.convertAndSend(<span class="string">"hello spring-rabbit"</span>);</span><br><span class="line">		context.destroy();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5、测试结果"><a href="#5、测试结果" class="headerlink" title="5、测试结果"></a>5、测试结果</h2><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553598029769.png" alt="1553598029769"></p><h2 id="6、注意"><a href="#6、注意" class="headerlink" title="6、注意"></a>6、注意</h2><p>以上消费者代码实现方式在<strong>spring-rabbit 2.0.0.RELEASE</strong>及以上版本启动会报错，具体原因尚未查明。</p><h1 id="十四、RabbitMQ-Spring集成-注解版本"><a href="#十四、RabbitMQ-Spring集成-注解版本" class="headerlink" title="十四、RabbitMQ - Spring集成-注解版本"></a>十四、RabbitMQ - Spring集成-注解版本</h1><p>敬请期待</p><h1 id="十五、RabbitMQ-SpringBoot集成"><a href="#十五、RabbitMQ-SpringBoot集成" class="headerlink" title="十五、RabbitMQ - SpringBoot集成"></a>十五、RabbitMQ - SpringBoot集成</h1><p>敬请期待</p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>关于 RabbitMQ 的五种队列，其实实际使用最多的是最后一种主题模式，通过模糊匹配，使得操作更加自如。那么我们总结一下有交换器参与的队列（最后三种队列）工作方式如下：</p><p><img src="/2017-03-21/RabbitMQ超详细教程.htm/1553598103778.png" alt="1553598103778"></p><h1 id="代码下载"><a href="#代码下载" class="headerlink" title="代码下载"></a>代码下载</h1><p><a href="https://github.com/amorous/RabbitMQ/tree/master/rabbitmq" target="_blank" rel="noopener">基础示例代码</a></p><p><a href="https://github.com/amorous/RabbitMQ/tree/master/rabbitmq-spring-xml" target="_blank" rel="noopener">RabbitMQ与Spring集成XML版本代码</a></p></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">------------ 本文结束 <i class="fa fa-heart"></i> 感谢您的阅读 ------------</div></div></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong> Du.Jiang</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://www.amorou.cn/2017-03-21/RabbitMQ超详细教程.html" title="RabbitMQ超详细教程">https://www.amorou.cn/2017-03-21/RabbitMQ超详细教程.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/RabbitMQ/" rel="tag"><i class="fa fa-tag"></i> RabbitMQ</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017-02-25/第一十一章：SpringBoot整合其他服务.html" rel="next" title="第一十一章：SpringBoot整合其他服务"><i class="fa fa-chevron-left"></i> 第一十一章：SpringBoot整合其他服务</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2017-03-27/Tomcat内置过滤器详解.html" rel="prev" title="Tomcat内置过滤器详解">Tomcat内置过滤器详解 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="Du.Jiang"><p class="site-author-name" itemprop="name">Du.Jiang</p><p class="site-description motion-element" itemprop="description">生活不知眼前的苟且、还有诗和远方的田野。</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">21</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">8</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">8</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="/atom.xml" rel="alternate"><i class="fa fa-rss"></i> RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/amorous" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:273131037@qq.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="http://wpa.qq.com/msgrd?v=3&uin=273131037&site=qq&menu=yes" target="_blank" title="QQ"><i class="fa fa-fw fa-qq"></i>QQ</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、为什么使用RabbitMQ"><span class="nav-text">1、为什么使用RabbitMQ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、RabbitMQ产生的背景"><span class="nav-text">2、RabbitMQ产生的背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、为什么叫RabbitMQ？"><span class="nav-text">3、为什么叫RabbitMQ？</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#一、RabbitMQ的安装"><span class="nav-text">一、RabbitMQ的安装</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、下载安装erlang"><span class="nav-text">1、下载安装erlang</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、下载安装RabbitMQ"><span class="nav-text">2、下载安装RabbitMQ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、激活-RabbitMQ’s-Management-Plugin"><span class="nav-text">3、激活 RabbitMQ’s Management Plugin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4、登录验证"><span class="nav-text">4、登录验证</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5、配置允许远程访问"><span class="nav-text">5、配置允许远程访问</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二、RabbitMQ概念"><span class="nav-text">二、RabbitMQ概念</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三、用户角色权限、virtual-hosts配置"><span class="nav-text">三、用户角色权限、virtual hosts配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、用户管理"><span class="nav-text">1、用户管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、角色管理"><span class="nav-text">2、角色管理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、virtual-hosts"><span class="nav-text">3、virtual hosts</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4、virtual-hosts授权"><span class="nav-text">4、virtual hosts授权</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四、RabbitMQ-简单队列"><span class="nav-text">四、RabbitMQ - 简单队列</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#五、RabbitMQ-–-Work-Queue（工作队列）"><span class="nav-text">五、RabbitMQ – Work Queue（工作队列）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、Round-robin-dispatching（轮询分发）"><span class="nav-text">1、Round-robin dispatching（轮询分发）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1、创建消息发送者：Send-java"><span class="nav-text">1、创建消息发送者：Send.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2、创建消息消费者1：Recv-1-java"><span class="nav-text">2、创建消息消费者1：Recv_1.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3、创建消息消费者2：Recv-2-java"><span class="nav-text">3、创建消息消费者2：Recv_2.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5、分析结果"><span class="nav-text">5、分析结果</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、Fair-dispatch（公平分发）"><span class="nav-text">2、Fair dispatch（公平分发）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1、创建消息发送者：Send-java-1"><span class="nav-text">1、创建消息发送者：Send.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2、创建消息消费者1：Recv-1-java-1"><span class="nav-text">2、创建消息消费者1：Recv_1.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3、创建消息消费者2：Recv-2-java-1"><span class="nav-text">3、创建消息消费者2：Recv_2.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4、测试结果"><span class="nav-text">4、测试结果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5、应用场景"><span class="nav-text">5、应用场景</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#六、Exchanges（交换机）"><span class="nav-text">六、Exchanges（交换机）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、direct"><span class="nav-text">1、direct</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、fanout"><span class="nav-text">2、fanout</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、topic"><span class="nav-text">3、topic</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#七、RabbitMQ-–-Publish-Subscribe（发布-订阅模式）"><span class="nav-text">七、RabbitMQ – Publish/Subscribe（发布/订阅模式）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、创建消息发送者：Send-java-2"><span class="nav-text">1、创建消息发送者：Send.java</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、创建消息消费者1：Recv-1-java-2"><span class="nav-text">2、创建消息消费者1：Recv_1.java</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、创建消息消费者2：Recv-2-java-2"><span class="nav-text">3、创建消息消费者2：Recv_2.java</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4、测试结果-1"><span class="nav-text">4、测试结果</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5、应用场景-1"><span class="nav-text">5、应用场景</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#八、RabbitMQ-–-Routing（路由模式）"><span class="nav-text">八、RabbitMQ – Routing（路由模式）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、创建消息发送者：Send-java-3"><span class="nav-text">1、创建消息发送者：Send.java</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、创建消息消费者1：Recv-1-java-3"><span class="nav-text">2、创建消息消费者1：Recv_1.java</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、创建消息消费者2：Recv-2-java-3"><span class="nav-text">3、创建消息消费者2：Recv_2.java</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4、测试结果-2"><span class="nav-text">4、测试结果</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5、应用场景-2"><span class="nav-text">5、应用场景</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#九、RabbitMQ-–-Topics（主题模式）"><span class="nav-text">九、RabbitMQ – Topics（主题模式）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、创建消息发送者：Send-java-4"><span class="nav-text">1、创建消息发送者：Send.java</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、创建消息消费者1：Recv-1-java-4"><span class="nav-text">2、创建消息消费者1：Recv_1.java</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、创建消息消费者2：Recv-2-java-4"><span class="nav-text">3、创建消息消费者2：Recv_2.java</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4、测试结果-3"><span class="nav-text">4、测试结果</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#十、RabbitMQ-消息应答ack机制"><span class="nav-text">十、RabbitMQ - 消息应答ack机制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、创建消息发送者：Send-java-5"><span class="nav-text">1、创建消息发送者：Send.java</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、自动应答-创建消息消费者：RecvAutoAck-java"><span class="nav-text">2、自动应答-创建消息消费者：RecvAutoAck.java</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、手动应答-创建消息消费者：RecvBasicAck-java"><span class="nav-text">3、手动应答-创建消息消费者：RecvBasicAck.java</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#方法1：basicAck（确认收到一个或多个消息）"><span class="nav-text">方法1：basicAck（确认收到一个或多个消息）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方法2：basicReject（拒绝一条收到的消息-单条拒绝）"><span class="nav-text">方法2：basicReject（拒绝一条收到的消息-单条拒绝）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方法3：basicNack（拒绝一条或多条收到的消息-批量拒绝）"><span class="nav-text">方法3：basicNack（拒绝一条或多条收到的消息-批量拒绝）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方法4：basicRecover（重新发送到队列中）"><span class="nav-text">方法4：basicRecover（重新发送到队列中）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4、注意"><span class="nav-text">4、注意</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#十一、RabbitMQ-消息的持久性"><span class="nav-text">十一、RabbitMQ - 消息的持久性</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、交换机持久化"><span class="nav-text">1、交换机持久化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建消息发送者代码：Send-java"><span class="nav-text">创建消息发送者代码：Send.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试结果"><span class="nav-text">测试结果</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、队列持久化"><span class="nav-text">2、队列持久化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建消息发送者代码：Send-java（引用上一步的代码）"><span class="nav-text">创建消息发送者代码：Send.java（引用上一步的代码）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建消息消费者代码：Recv-java"><span class="nav-text">创建消息消费者代码：Recv.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试结果-1"><span class="nav-text">测试结果</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、消息持久化"><span class="nav-text">3、消息持久化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#修改消息发送者代码：Send-java"><span class="nav-text">修改消息发送者代码：Send.java</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4、小结"><span class="nav-text">4、小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#十二、RabbitMQ-–消息确认机制"><span class="nav-text">十二、RabbitMQ –消息确认机制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、事务机制"><span class="nav-text">1、事务机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#发送者使用事务"><span class="nav-text">发送者使用事务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建消息发送者代码：Send-java-1"><span class="nav-text">创建消息发送者代码：Send.java</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消费者使用事务"><span class="nav-text">消费者使用事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结"><span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、Confirm发送方确认模式"><span class="nav-text">2、Confirm发送方确认模式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#方式一：普通Confirm模式：SendConfirm-java"><span class="nav-text">方式一：普通Confirm模式：SendConfirm.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方式二：批量Confirm模式：SendBatchConfirm-java"><span class="nav-text">方式二：批量Confirm模式：SendBatchConfirm.java</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方式三：异步Confirm模式：SendAsynConfirm-java"><span class="nav-text">方式三：异步Confirm模式：SendAsynConfirm.java</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#十三、RabbitMQ-–-Spring集成-XML版本"><span class="nav-text">十三、RabbitMQ – Spring集成-XML版本</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1、新建Maven项目，修改pom-xml"><span class="nav-text">1、新建Maven项目，修改pom.xml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2、新建spring-rabbitmq-xml配置文件"><span class="nav-text">2、新建spring-rabbitmq.xml配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3、新建消费者"><span class="nav-text">3、新建消费者</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#TestConsumer1-java（指定方法方式）"><span class="nav-text">TestConsumer1.java（指定方法方式）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TestConsumer2-java（实现接口方式）"><span class="nav-text">TestConsumer2.java（实现接口方式）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4、新建启动类：SpringMain-java"><span class="nav-text">4、新建启动类：SpringMain.java</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5、测试结果"><span class="nav-text">5、测试结果</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6、注意"><span class="nav-text">6、注意</span></a></li></ol><li class="nav-item nav-level-1"><a class="nav-link" href="#十四、RabbitMQ-Spring集成-注解版本"><span class="nav-text">十四、RabbitMQ - Spring集成-注解版本</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#十五、RabbitMQ-SpringBoot集成"><span class="nav-text">十五、RabbitMQ - SpringBoot集成</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#总结"><span class="nav-text">总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#代码下载"><span class="nav-text">代码下载</span></a></li></div></div></section></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><script async src="/js/src/busuanzi.pure.mini.js"></script><div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2019</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Du.Jiang<br></span><div class="powered-by"><i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv"> 本站访客数：<span id="busuanzi_value_site_uv"></span></span></div></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script type="text/javascript">var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: '9IlpBWYaYB9bj7zh95OHnYKj-gzGzoHsz',
        appKey: 'Nxmg1wVVjSmVa7e6n3TWP8V8',
        placeholder: '老司机来一发吧ヾ(o◕∀◕)ﾉヾ',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });</script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;w<0&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><script>!function(){var t=document.createElement("script"),s=window.location.protocol.split(":")[0];"https"===s?t.src="https://zz.bdstatic.com/linksubmit/push.js":t.src="http://push.zhanzhang.baidu.com/push.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script type="text/x-mathjax-config">MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });</script><script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js"></script></body></html><!-- rebuild by neat -->